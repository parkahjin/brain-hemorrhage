# 🚀 실행 가이드 - 뇌출혈 진단 시스템

내일까지 완료해야 하는 작업들의 단계별 가이드

---

## 📋 전체 작업 리스트

### ✅ 완료된 작업
1. ✅ Kaggle/논문 성공 사례 조사 및 분석
2. ✅ 최적 하이퍼파라미터 정리 (`Model_code/최적_하이퍼파라미터_정리.md`)
3. ✅ ResNet50 최적화 학습 코드 작성 (`Model_code/ResNet50_Optimized_90percent.py`)
4. ✅ 범용 전처리 모듈 작성 (`Model_code/preprocessing_utils.py`)
5. ✅ Grad-CAM 구현 (`Model_code/gradcam_utils.py`)
6. ✅ Streamlit UI 개선 (`Streamlit/brain_ct_improved.py`)
7. ✅ 문서 작성 (README, 가이드)

### 🔄 진행해야 할 작업
1. 🔄 Google Colab에서 최적화 모델 학습 (4-5시간)
2. 🔄 인터넷 CT 이미지로 테스트 (1-2시간)
3. 🔄 Streamlit 앱 최종 검증 (30분)

---

## 📝 Step 1: Google Colab에서 모델 학습

### 1-1. Colab 노트북 준비
```python
# 새 Colab 노트북 생성
# https://colab.research.google.com

# GPU 런타임 설정
# 런타임 > 런타임 유형 변경 > GPU 선택
```

### 1-2. Google Drive 마운트
```python
from google.colab import drive
drive.mount('/content/drive')
```

### 1-3. 데이터 경로 확인
```python
import os

# 데이터 경로 확인
train_dir = "/content/drive/MyDrive/brain_ct/train"
test_dir = "/content/drive/MyDrive/brain_ct/test"

print("Train 폴더:", os.listdir(train_dir))
print("Test 폴더:", os.listdir(test_dir))

# 데이터 개수 확인
!find $train_dir -type f | wc -l
!find $test_dir -type f | wc -l
```

### 1-4. 코드 업로드 및 실행

**방법 1: 파일 직접 업로드**
```python
# Colab 좌측 파일 탭에서
# Model_code/ResNet50_Optimized_90percent.py 업로드

# 실행
%run ResNet50_Optimized_90percent.py
```

**방법 2: 코드 복사 붙여넣기**
- `ResNet50_Optimized_90percent.py` 내용 전체 복사
- Colab 셀에 붙여넣기 후 실행

### 1-5. 학습 모니터링
```python
# 학습 진행 중 확인 사항:
# 1. Stage 1 (5 epochs) - Top layers 학습
#    - 예상 시간: 30-45분
#    - Val Accuracy 목표: 85%+

# 2. Stage 2 (25 epochs) - Fine-tuning
#    - 예상 시간: 3-4시간
#    - Val Accuracy 목표: 90%+

# 3. Early Stopping 작동 확인
#    - Patience=5로 설정되어 있음
#    - 개선 없으면 자동 종료

# 4. 학습 곡선 저장 확인
#    - training_curves.png 생성됨
```

### 1-6. 결과 확인 및 저장
```python
# 최종 모델 파일 확인
!ls -lh /content/drive/MyDrive/*.h5

# 다운로드할 파일들:
# 1. resnet50_final_optimized.h5  (최종 모델)
# 2. training_curves.png          (학습 곡선)
# 3. resnet50_stage1_best.h5      (Stage 1 best)
# 4. resnet50_stage2_best.h5      (Stage 2 best)
```

### 1-7. 모델 성능 확인
```python
# 학습 완료 후 출력된 정보 확인:
# - 최종 Test Accuracy: ___%
# - Stage 1 최고 정확도: ___%
# - Stage 2 최고 정확도: ___%

# 목표: 90% 이상 달성!
```

---

## 🧪 Step 2: 인터넷 CT 이미지로 테스트

### 2-1. 테스트 이미지 수집

**뇌출혈 CT 이미지 찾기:**
```
Google 검색:
1. "brain hemorrhage CT scan"
2. "intracranial hemorrhage CT"
3. "ICH CT image"
4. "subdural hematoma CT"

추천 사이트:
- Radiopaedia.org
- Google Images (의료 이미지)
- 의학 교육 사이트
```

**정상 뇌 CT 이미지 찾기:**
```
Google 검색:
1. "normal brain CT scan"
2. "healthy brain CT image"

주의: 저작권 확인 (교육/연구 목적)
```

**이미지 다운로드:**
- 최소 10개 이상 (hemorrhage 5개 + normal 5개)
- JPG 또는 PNG 형식
- 고해상도 선호 (하지만 저해상도도 테스트)

### 2-2. Colab에서 테스트 (선택)

```python
# 이미지 업로드
from google.colab import files
uploaded = files.upload()

# 전처리 모듈 불러오기
# (preprocessing_utils.py를 Colab에 업로드해야 함)
from preprocessing_utils import CTImagePreprocessor
from gradcam_utils import GradCAM

# 모델 로드
from tensorflow.keras.models import load_model
model = load_model('/content/drive/MyDrive/resnet50_final_optimized.h5')

# 이미지 테스트
for filename in uploaded.keys():
    print(f"\n테스트: {filename}")

    # 전처리
    preprocessor = CTImagePreprocessor()
    image = preprocessor.preprocess(filename)

    # 예측
    pred = model.predict(image)[0][0]
    label = "hemorrhage" if pred >= 0.5 else "normal"

    print(f"예측: {label} ({pred:.4f})")

    # Grad-CAM
    gradcam = GradCAM(model)
    result = gradcam.explain_prediction(filename, preprocessor)
    print(result['explanation'])
```

### 2-3. 로컬에서 테스트 (Streamlit)

**준비사항:**
```bash
# 1. 학습된 모델 다운로드
# resnet50_final_optimized.h5를 model/ 폴더에 배치

# 2. 전처리/Grad-CAM 모듈 확인
# Model_code/preprocessing_utils.py
# Model_code/gradcam_utils.py

# 3. Streamlit 앱 실행
cd Streamlit
streamlit run brain_ct_improved.py
```

**테스트 절차:**
1. 브라우저에서 `http://localhost:8501` 접속
2. 다운로드한 인터넷 CT 이미지 업로드
3. 모델 선택: "ResNet50 Fine-tuned (최적화)"
4. Grad-CAM 시각화 확인
5. 예측 결과 확인

**확인 사항:**
- ✅ 뇌출혈 이미지 → "hemorrhage"로 정확히 예측
- ✅ 정상 이미지 → "normal"로 정확히 예측
- ✅ Grad-CAM 히트맵이 이상 부위를 제대로 표시
- ✅ 설명 텍스트가 적절하게 생성됨

---

## 🔍 Step 3: Streamlit 앱 최종 검증

### 3-1. 기능 체크리스트

**이미지 업로드 및 전처리:**
- [ ] JPG 이미지 업로드 가능
- [ ] PNG 이미지 업로드 가능
- [ ] 고해상도 이미지 처리 (2000x2000+)
- [ ] 저해상도 이미지 처리 (512x512)
- [ ] 에러 처리 (잘못된 파일)

**모델 예측:**
- [ ] ResNet50 Fine-tuned 모델 로드
- [ ] 예측 확률 표시 (0-100%)
- [ ] 신뢰도 표시 (높음/보통/낮음)
- [ ] 임계값 조정 가능

**Grad-CAM 시각화:**
- [ ] 원본 이미지 표시
- [ ] 히트맵 생성
- [ ] 오버레이 이미지 생성
- [ ] 투명도 조정 가능

**설명 텍스트:**
- [ ] 진단 결과 (hemorrhage/normal)
- [ ] 신뢰도 표시
- [ ] 주요 관심 영역 설명
- [ ] 의료 면책 조항 표시

**UI/UX:**
- [ ] 반응형 레이아웃 (3개 컬럼)
- [ ] 진행 상태 표시 (Progress bar)
- [ ] 결과 박스 색상 (빨강/초록)
- [ ] 사용 안내 표시

### 3-2. 에러 시나리오 테스트

**테스트 케이스:**
```python
# 1. 잘못된 파일 형식 (PDF, TXT)
# → 에러 메시지 표시되어야 함

# 2. 너무 작은 이미지 (32x32)
# → "이미지가 너무 작습니다" 메시지

# 3. 뇌 CT가 아닌 이미지 (풍경 사진 등)
# → 예측은 되지만 낮은 신뢰도

# 4. 그레이스케일 vs RGB
# → 둘 다 정상 처리되어야 함

# 5. 모델 파일 없음
# → "모델 파일이 없습니다" 에러
```

---

## 📊 Step 4: 최종 결과 정리

### 4-1. 성능 기록

**정확도:**
```
Training Accuracy (Stage 2 최종): ____%
Validation Accuracy (Stage 2 최종): ____%
Test Accuracy (최종 평가): ____%

목표 달성 여부: [ ] 90% 이상 / [ ] 90% 미만
```

**인터넷 이미지 테스트:**
```
테스트 이미지 수: ___ 개
정확한 예측 수: ___ 개
정확도: ____%

Hemorrhage 이미지:
- 정답: ___ / ___ (___%)

Normal 이미지:
- 정답: ___ / ___ (___%)
```

### 4-2. 스크린샷 캡처

**필수 스크린샷:**
1. Colab 학습 완료 화면 (최종 정확도)
2. 학습 곡선 (training_curves.png)
3. Streamlit 앱 메인 화면
4. 뇌출혈 이미지 진단 결과 + Grad-CAM
5. 정상 이미지 진단 결과 + Grad-CAM
6. 인터넷 이미지 테스트 결과 (2-3개)

### 4-3. 문제점 및 해결 방안

**90% 미달 시:**
```
현재 정확도: ____%
부족분: ___%

추가 시도:
1. [ ] Epochs 증가 (30 → 50)
2. [ ] Learning rate 조정 (1e-4 → 5e-5)
3. [ ] Class weight 강화 (1.3 → 1.5)
4. [ ] Augmentation 강화
5. [ ] Kaggle 90%+ 코드 직접 적용
```

**Grad-CAM 이상 시:**
```
문제: 히트맵이 관련 없는 부위 표시

해결:
1. [ ] Layer 변경 (마지막 Conv → 이전 Conv)
2. [ ] Alpha 값 조정
3. [ ] Colormap 변경 (JET → VIRIDIS)
```

---

## ⏰ 시간 계획

### 내일 일정 (총 8-10시간)

**오전 (4-5시간):**
- 09:00-09:30: Colab 설정 및 데이터 확인
- 09:30-14:00: 모델 학습 실행 (중간에 점심)
  - Stage 1: 30-45분
  - Stage 2: 3-4시간

**오후 (4-5시간):**
- 14:00-15:00: 인터넷 이미지 수집 (10-20개)
- 15:00-17:00: 이미지 테스트 및 검증
  - Colab 테스트: 30분
  - Streamlit 테스트: 1시간
  - 에러 수정: 30분
- 17:00-18:00: 최종 정리
  - 스크린샷 캡처
  - 성능 기록
  - 문서 업데이트

**예비 시간:**
- 18:00-20:00: 90% 미달 시 추가 튜닝

---

## 🎯 성공 기준

### 필수 (Must Have)
- ✅ Test Accuracy ≥ 90%
- ✅ 인터넷 CT 이미지 정확히 예측
- ✅ Grad-CAM 시각화 정상 작동
- ✅ Streamlit 앱 완전 작동

### 권장 (Should Have)
- ✅ 설명 텍스트 자동 생성
- ✅ 의료 면책 조항 포함
- ✅ 반응형 UI

### 선택 (Nice to Have)
- 🔄 DICOM 형식 지원
- 🔄 PDF 리포트 생성
- 🔄 다중 이미지 업로드

---

## 📞 문제 해결

### 자주 발생하는 문제

**1. Colab GPU 메모리 부족**
```python
# 해결: Batch size 감소
batch_size = 16  # 32 → 16

# 또는 Mixed Precision 사용
from tensorflow.keras import mixed_precision
mixed_precision.set_global_policy('mixed_float16')
```

**2. Streamlit에서 모델 로드 실패**
```python
# 확인: 모델 파일 경로
import os
print(os.path.exists('model/resnet50_final_optimized.h5'))

# 해결: 절대 경로 사용
model_path = os.path.join(os.path.dirname(__file__), '..', 'model', 'resnet50_final_optimized.h5')
```

**3. Grad-CAM 에러**
```python
# 확인: Layer 이름
for layer in model.layers:
    print(layer.name, layer.output_shape)

# 해결: 올바른 Conv layer 지정
gradcam = GradCAM(model, layer_name='conv5_block3_out')
```

---

## ✅ 최종 체크리스트

**학습 완료:**
- [ ] Colab 학습 성공
- [ ] Test Accuracy ≥ 90%
- [ ] 모델 파일 다운로드 (.h5)
- [ ] 학습 곡선 저장 (.png)

**테스트 완료:**
- [ ] 인터넷 이미지 10개+ 수집
- [ ] Hemorrhage 이미지 정확히 예측
- [ ] Normal 이미지 정확히 예측
- [ ] Grad-CAM 정상 작동

**Streamlit 완료:**
- [ ] 앱 정상 실행
- [ ] 이미지 업로드 작동
- [ ] 예측 결과 표시
- [ ] Grad-CAM 표시
- [ ] 설명 텍스트 생성

**문서 완료:**
- [ ] README.md 작성
- [ ] 실행 가이드 작성
- [ ] 스크린샷 캡처
- [ ] 성능 기록

---

**화이팅! 내일 성공적으로 90% 달성하세요! 🎉**
